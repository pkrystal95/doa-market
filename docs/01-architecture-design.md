# 1단계: 전체 시스템 아키텍처 설계

## 목차

- [오픈마켓 시스템 전체 아키텍처](#오픈마켓-시스템-전체-아키텍처)
- [핵심 아키텍처 원칙](#핵심-아키텍처-원칙)
- [주요 서비스 목록](#주요-서비스-목록)
- [데이터 흐름 예시](#데이터-흐름-예시-상품-주문-프로세스)

---

## 오픈마켓 시스템 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Client Layer (클라이언트 계층)                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │  Admin Web       │  │  Seller Web      │  │  User Mobile App │          │
│  │  (Next.js)       │  │  (Next.js)       │  │  (Flutter)       │          │
│  │  - SSR/ISR       │  │  - SSR/ISR       │  │  - iOS/Android   │          │
│  │  - 상품관리       │  │  - 판매자 대시보드│  │  - 상품검색/주문 │          │
│  │  - 주문관리       │  │  - 상품등록       │  │  - 결제/배송추적 │          │
│  │  - 정산관리       │  │  - 정산조회       │  │  - 마이페이지    │          │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘          │
│           │                     │                     │                     │
└───────────┼─────────────────────┼─────────────────────┼─────────────────────┘
            │                     │                     │
            └─────────────────────┼─────────────────────┘
                                  │
┌─────────────────────────────────┼─────────────────────────────────────────────┐
│                          CDN Layer (CDN 계층)                                  │
├─────────────────────────────────┼─────────────────────────────────────────────┤
│                                 ▼                                              │
│                        ┌──────────────────┐                                   │
│                        │  CloudFront      │                                   │
│                        │  - Static Assets │                                   │
│                        │  - Image Cache   │                                   │
│                        │  - WAF           │                                   │
│                        └────────┬─────────┘                                   │
└─────────────────────────────────┼─────────────────────────────────────────────┘
                                  │
┌─────────────────────────────────┼─────────────────────────────────────────────┐
│                      API Gateway Layer (API 게이트웨이 계층)                   │
├─────────────────────────────────┼─────────────────────────────────────────────┤
│                                 ▼                                              │
│     ┌─────────────────────────────────────────────────────────────┐           │
│     │              AWS API Gateway (REST/HTTP)                    │           │
│     │  - JWT 인증 검증 (Lambda Authorizer)                        │           │
│     │  - Rate Limiting & Throttling                              │           │
│     │  - Request/Response Transformation                         │           │
│     │  - WAF Integration                                         │           │
│     └───────┬─────────────┬──────────────┬──────────────┬────────┘           │
└─────────────┼─────────────┼──────────────┼──────────────┼────────────────────┘
              │             │              │              │
┌─────────────┼─────────────┼──────────────┼──────────────┼────────────────────┐
│       Authentication Layer (인증 계층)    │              │                    │
├─────────────┼─────────────┼──────────────┼──────────────┼────────────────────┤
│             ▼             │              │              │                    │
│     ┌──────────────┐      │              │              │                    │
│     │   Cognito    │      │              │              │                    │
│     │  User Pools  │◄─────┼──────────────┼──────────────┼────JWT 검증        │
│     └──────────────┘      │              │              │                    │
└───────────────────────────┼──────────────┼──────────────┼────────────────────┘
                            │              │              │
┌───────────────────────────┼──────────────┼──────────────┼────────────────────┐
│            Microservices Layer (마이크로서비스 계층)                           │
│                   EKS Cluster / ECS Fargate                                   │
├───────────────────────────┼──────────────┼──────────────┼────────────────────┤
│                           ▼              ▼              ▼                    │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │                        Application Load Balancer                       │  │
│  └────┬───────┬────────┬────────┬────────┬────────┬────────┬──────────┬──┘  │
│       │       │        │        │        │        │        │          │     │
│       ▼       ▼        ▼        ▼        ▼        ▼        ▼          ▼     │
│  ┌────────┐ ┌─────┐ ┌─────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌───────┐  │
│  │ Auth   │ │User │ │Prod │ │Order │ │Pay   │ │Ship  │ │Seller│ │Settle │  │
│  │Service │ │Svc  │ │Svc  │ │Svc   │ │Svc   │ │Svc   │ │Svc   │ │Svc    │  │
│  │        │ │     │ │     │ │      │ │      │ │      │ │      │ │       │  │
│  │:3001   │ │:3002│ │:3003│ │:3004 │ │:3005 │ │:3006 │ │:3007 │ │:3008  │  │
│  └───┬────┘ └──┬──┘ └──┬──┘ └───┬──┘ └───┬──┘ └───┬──┘ └───┬──┘ └───┬───┘  │
│      │         │       │        │        │        │        │        │      │
│  ┌────────┐ ┌─────┐ ┌─────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌───────┐  │
│  │Coupon  │ │Inven│ │Notif│ │Review│ │Search│ │Admin │ │File  │ │Stats  │  │
│  │Service │ │Svc  │ │Svc  │ │Svc   │ │Svc   │ │Svc   │ │Svc   │ │Svc    │  │
│  │        │ │     │ │     │ │      │ │      │ │      │ │      │ │       │  │
│  │:3009   │ │:3010│ │:3011│ │:3012 │ │:3013 │ │:3014 │ │:3015 │ │:3016  │  │
│  └────────┘ └─────┘ └─────┘ └──────┘ └───┬──┘ └──────┘ └──────┘ └───────┘  │
│                                           │                                   │
│  [각 서비스는 독립적으로 배포 가능한 컨테이너]                                 │
│  [Service Mesh: AWS App Mesh 또는 Istio]                                      │
└───────────────────────────────────────────┼───────────────────────────────────┘
                                            │
┌───────────────────────────────────────────┼───────────────────────────────────┐
│                    Event-Driven Layer (이벤트 기반 계층)                       │
├───────────────────────────────────────────┼───────────────────────────────────┤
│                                           ▼                                   │
│                        ┌────────────────────────────┐                         │
│                        │   Amazon EventBridge       │                         │
│                        │   (Event Bus)              │                         │
│                        │                            │                         │
│                        │  - order.created           │                         │
│                        │  - payment.completed       │                         │
│                        │  - inventory.updated       │                         │
│                        │  - shipping.dispatched     │                         │
│                        │  - settlement.calculated   │                         │
│                        └──┬────┬────┬────┬────┬────┘                         │
│                           │    │    │    │    │                              │
│           ┌───────────────┼────┼────┼────┼────┼─────────────┐                │
│           ▼               ▼    ▼    ▼    ▼    ▼             ▼                │
│      ┌────────┐     ┌────────────────────────────┐     ┌─────────┐           │
│      │ SQS    │     │    Lambda Functions        │     │ SQS DLQ │           │
│      │ Queues │     │                            │     │ (Dead   │           │
│      │        │     │  - Payment Processor       │     │ Letter) │           │
│      │ order  │─────┤  - Inventory Updater       │     └─────────┘           │
│      │ payment│     │  - Notification Sender     │                           │
│      │ ship   │     │  - Settlement Calculator   │                           │
│      │ notif  │     │  - Analytics Processor     │                           │
│      │ settle │     │  - Image Optimizer         │                           │
│      └────────┘     └────────────────────────────┘                           │
└───────────────────────────────────────────────────────────────────────────────┘
                                            │
┌───────────────────────────────────────────┼───────────────────────────────────┐
│                     Data Layer (데이터 계층)                                   │
├───────────────────────────────────────────┼───────────────────────────────────┤
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────┐    │
│  │                        Cache Layer (캐시)                            │    │
│  │  ┌──────────────────────────────────────────────────────┐            │    │
│  │  │        ElastiCache Redis (클러스터 모드)              │            │    │
│  │  │  - Session Storage                                   │            │    │
│  │  │  - Product Cache                                     │            │    │
│  │  │  - API Response Cache                                │            │    │
│  │  │  - Rate Limiting Counter                             │            │    │
│  │  └──────────────────────────────────────────────────────┘            │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────┐    │
│  │                   Primary Database (주 데이터베이스)                 │    │
│  │  ┌──────────────────────────────────────────────────────┐            │    │
│  │  │        Amazon RDS (PostgreSQL Multi-AZ)              │            │    │
│  │  │                                                       │            │    │
│  │  │  Databases:                                          │            │    │
│  │  │  - users_db        (사용자, 판매자, 관리자)           │            │    │
│  │  │  - products_db     (상품, 카테고리, 옵션)            │            │    │
│  │  │  - orders_db       (주문, 주문상품)                  │            │    │
│  │  │  - payments_db     (결제, 환불)                      │            │    │
│  │  │  - settlements_db  (정산)                            │            │    │
│  │  │                                                       │            │    │
│  │  │  Read Replicas (읽기 전용 복제본) x 2                │            │    │
│  │  └──────────────────────────────────────────────────────┘            │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────┐    │
│  │                  NoSQL Database (NoSQL 데이터베이스)                 │    │
│  │  ┌──────────────────────────────────────────────────────┐            │    │
│  │  │             Amazon DynamoDB                           │            │    │
│  │  │                                                       │            │    │
│  │  │  Tables:                                             │            │    │
│  │  │  - Sessions        (세션 관리)                        │            │    │
│  │  │  - Carts           (장바구니)                         │            │    │
│  │  │  - Wishlists       (찜)                              │            │    │
│  │  │  - ProductViews    (상품 조회 로그)                   │            │    │
│  │  │  - OrderEvents     (주문 이벤트 로그)                 │            │    │
│  │  │  - AuditLogs       (감사 로그)                        │            │    │
│  │  │                                                       │            │    │
│  │  │  [Global Secondary Indexes configured]               │            │    │
│  │  └──────────────────────────────────────────────────────┘            │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────┐    │
│  │                    Search Engine (검색 엔진)                          │    │
│  │  ┌──────────────────────────────────────────────────────┐            │    │
│  │  │        Amazon OpenSearch Service                      │            │    │
│  │  │                                                       │            │    │
│  │  │  Indices:                                            │            │    │
│  │  │  - products        (상품 전문 검색)                   │            │    │
│  │  │  - orders          (주문 검색)                        │            │    │
│  │  │  - logs            (애플리케이션 로그)                │            │    │
│  │  │  - analytics       (분석 데이터)                      │            │    │
│  │  └──────────────────────────────────────────────────────┘            │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────┐    │
│  │                   Object Storage (객체 스토리지)                      │    │
│  │  ┌──────────────────────────────────────────────────────┐            │    │
│  │  │                  Amazon S3                            │            │    │
│  │  │                                                       │            │    │
│  │  │  Buckets:                                            │            │    │
│  │  │  - product-images     (상품 이미지)                  │            │    │
│  │  │  - user-uploads       (사용자 업로드)                │            │    │
│  │  │  - invoice-documents  (정산서/계약서)                │            │    │
│  │  │  - logs-archive       (로그 아카이브)                │            │    │
│  │  │  - backup-data        (백업)                         │            │    │
│  │  │                                                       │            │    │
│  │  │  [Lifecycle Policies, Versioning, Encryption]        │            │    │
│  │  └──────────────────────────────────────────────────────┘            │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
└────────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────────┐
│                 Supporting Services (지원 서비스 계층)                          │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐            │
│  │  AWS Secrets     │  │  AWS Systems     │  │  Amazon SES      │            │
│  │  Manager         │  │  Manager         │  │  (Email)         │            │
│  │  - DB Credentials│  │  - Config Params │  │  - Notifications │            │
│  │  - API Keys      │  │  - Feature Flags │  │  - Newsletters   │            │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘            │
│                                                                                 │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐            │
│  │  Amazon SNS      │  │  AWS CloudWatch  │  │  AWS X-Ray       │            │
│  │  (Push Notif)    │  │  - Logs          │  │  - Distributed   │            │
│  │  - iOS/Android   │  │  - Metrics       │  │    Tracing       │            │
│  │  - SMS           │  │  - Alarms        │  │  - Performance   │            │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘            │
│                                                                                 │
└────────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────────┐
│                      Network Layer (네트워크 계층)                              │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  VPC (Virtual Private Cloud)                                                   │
│  ┌──────────────────────────────────────────────────────────────────────────┐ │
│  │  Region: ap-northeast-2 (Seoul)                                          │ │
│  │  CIDR: 10.0.0.0/16                                                       │ │
│  │                                                                          │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │ │
│  │  │  Public Subnets (퍼블릭 서브넷)                                 │    │ │
│  │  │  - ALB                                                          │    │ │
│  │  │  - NAT Gateway                                                  │    │ │
│  │  │  - Bastion Host                                                 │    │ │
│  │  │  AZ-A: 10.0.1.0/24  |  AZ-C: 10.0.2.0/24                       │    │ │
│  │  └─────────────────────────────────────────────────────────────────┘    │ │
│  │                                                                          │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │ │
│  │  │  Private Subnets - Application (프라이빗 서브넷 - 애플리케이션)│    │ │
│  │  │  - EKS Worker Nodes / ECS Tasks                                │    │ │
│  │  │  - Microservices                                               │    │ │
│  │  │  AZ-A: 10.0.10.0/24  |  AZ-C: 10.0.11.0/24                     │    │ │
│  │  └─────────────────────────────────────────────────────────────────┘    │ │
│  │                                                                          │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │ │
│  │  │  Private Subnets - Data (프라이빗 서브넷 - 데이터)             │    │ │
│  │  │  - RDS                                                          │    │ │
│  │  │  - ElastiCache                                                  │    │ │
│  │  │  - OpenSearch                                                   │    │ │
│  │  │  AZ-A: 10.0.20.0/24  |  AZ-C: 10.0.21.0/24                     │    │ │
│  │  └─────────────────────────────────────────────────────────────────┘    │ │
│  │                                                                          │ │
│  │  Security Groups:                                                        │ │
│  │  - alb-sg           (80, 443 from Internet)                             │ │
│  │  - app-sg           (3000-3999 from alb-sg)                             │ │
│  │  - db-sg            (5432 from app-sg)                                  │ │
│  │  - cache-sg         (6379 from app-sg)                                  │ │
│  │  - search-sg        (443, 9200 from app-sg)                             │ │
│  │                                                                          │ │
│  │  VPC Endpoints:                                                          │ │
│  │  - S3, DynamoDB, Secrets Manager, CloudWatch                            │ │
│  └──────────────────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────────────────────┘
```

---

## 핵심 아키텍처 원칙

### 1. 마이크로서비스 분리 원칙

- **도메인 주도 설계(DDD)**: 각 서비스는 bounded context로 명확히 분리
- **데이터베이스 분리**: 각 서비스가 독립적인 데이터베이스 스키마 소유
- **독립 배포**: 서비스 간 의존성 최소화로 독립적 배포 가능
- **API 계약**: OpenAPI 스펙을 통한 명확한 API 계약 정의

### 2. 이벤트 기반 아키텍처

- **비동기 통신**: EventBridge를 통한 느슨한 결합
- **이벤트 소싱**: 주요 비즈니스 이벤트 모두 기록
- **재처리 가능**: SQS와 DLQ를 통한 안정적인 메시지 처리
- **사가 패턴**: 분산 트랜잭션 관리

### 3. 확장성 설계

- **수평 확장**: EKS/ECS Auto Scaling으로 트래픽 대응
- **캐시 전략**: Redis를 통한 데이터베이스 부하 감소
- **읽기 복제본**: RDS Read Replica로 읽기 성능 향상
- **CDN**: CloudFront로 정적 자원 글로벌 배포

### 4. 보안 설계

- **네트워크 격리**: VPC 서브넷 분리 및 Security Group
- **암호화**: 전송/저장 데이터 모두 암호화 (TLS, KMS)
- **인증/인가**: Cognito + JWT, API Gateway Authorizer
- **비밀 관리**: Secrets Manager로 민감 정보 관리

### 5. 관찰성(Observability)

- **분산 추적**: X-Ray로 마이크로서비스 간 호출 추적
- **중앙 로깅**: CloudWatch Logs + OpenSearch
- **메트릭 수집**: CloudWatch Metrics, Custom Metrics
- **알람**: CloudWatch Alarms로 장애 감지

---

## 주요 서비스 목록

| 서비스명             | 포트 | 역할                          | 데이터베이스                        |
| -------------------- | ---- | ----------------------------- | ----------------------------------- |
| auth-service         | 3001 | 인증/인가, JWT 발급           | RDS users_db                        |
| user-service         | 3002 | 사용자 관리                   | RDS users_db                        |
| product-service      | 3003 | 상품 관리, 카테고리           | RDS products_db, OpenSearch         |
| order-service        | 3004 | 주문 처리                     | RDS orders_db, DynamoDB OrderEvents |
| payment-service      | 3005 | 결제 처리, PG 연동            | RDS payments_db                     |
| shipping-service     | 3006 | 배송 관리, 택배사 연동        | RDS orders_db                       |
| seller-service       | 3007 | 판매자 관리                   | RDS users_db                        |
| settlement-service   | 3008 | 정산 관리                     | RDS settlements_db                  |
| coupon-service       | 3009 | 쿠폰/프로모션                 | RDS products_db                     |
| inventory-service    | 3010 | 재고 관리                     | RDS products_db                     |
| notification-service | 3011 | 알림 발송 (푸시, 이메일, SMS) | DynamoDB                            |
| review-service       | 3012 | 리뷰/평점 관리                | RDS products_db                     |
| search-service       | 3013 | 통합 검색                     | OpenSearch                          |
| admin-service        | 3014 | 관리자 기능                   | 모든 DB 읽기                        |
| file-service         | 3015 | 파일 업로드/다운로드          | S3                                  |
| stats-service        | 3016 | 통계/분석                     | OpenSearch, DynamoDB                |

---

## 데이터 흐름 예시: 상품 주문 프로세스

```
1. [User App] → [API Gateway] → [Order Service]
   - POST /api/v1/orders
   - JWT 검증, 장바구니 확인

2. [Order Service] → [EventBridge]
   - Publish: order.created

3. [EventBridge] → [Multiple Consumers]
   - → [Payment Service] (결제 처리 시작)
   - → [Inventory Service] (재고 확인/예약)
   - → [Notification Service] (주문 확인 알림)

4. [Payment Service] → [PG API] → [EventBridge]
   - Publish: payment.completed

5. [EventBridge] → [Shipping Service]
   - Publish: shipping.requested
   - 배송지 정보 확인, 택배사 연동

6. [Shipping Service] → [EventBridge]
   - Publish: shipping.dispatched

7. [EventBridge] → [Multiple Consumers]
   - → [Notification Service] (배송 시작 알림)
   - → [Order Service] (주문 상태 업데이트)
   - → [Settlement Service] (정산 데이터 집계)
```

---

## 기술 스택 요약

### Frontend

- **Admin Web**: Next.js 15+ (App Router, TypeScript, React Server Components)
- **Seller Web**: Next.js 15+ (App Router, TypeScript)
- **User App**: Flutter 3.x (Dart, iOS/Android)

### Backend

- **Runtime**: Node.js 20 LTS
- **Framework**: Express.js / NestJS
- **Language**: TypeScript
- **API Documentation**: OpenAPI 3.0 (Swagger)

### Infrastructure (AWS)

### DevOps

- **IaC**: Terraform 또는 AWS CDK
- **CI/CD**: GitHub Actions
- **Container Registry**: Amazon ECR
- **Secret Management**: AWS Secrets Manager

---

**작성일**: 2025-12-03
**버전**: 1.0
