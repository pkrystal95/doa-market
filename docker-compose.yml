# DOA Market Local Development Environment
# Version: 1.0
# Run: docker-compose up -d
# Stop: docker-compose down
# Clean: docker-compose down -v

version: '3.8'

services:
  # ============================================
  # PostgreSQL Database
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: doa-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-databases.sql:/docker-entrypoint-initdb.d/init-databases.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - doa-network

  # ============================================
  # Redis Cache
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: doa-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass redis123
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - doa-network

  # ============================================
  # LocalStack (AWS Services Emulator)
  # ============================================
  localstack:
    image: localstack/localstack:latest
    container_name: doa-localstack
    environment:
      SERVICES: s3,sqs,sns,dynamodb,secretsmanager,events
      DEBUG: 1
      DATA_DIR: /tmp/localstack/data
      AWS_DEFAULT_REGION: ap-northeast-2
    ports:
      - "4566:4566"
    volumes:
      - localstack_data:/tmp/localstack
      - ./scripts/localstack-init.sh:/etc/localstack/init/ready.d/init.sh
    networks:
      - doa-network

  # ============================================
  # OpenSearch (Search Engine)
  # ============================================
  opensearch:
    image: opensearchproject/opensearch:2.11.0
    container_name: doa-opensearch
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - DISABLE_SECURITY_PLUGIN=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "9200:9200"
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    networks:
      - doa-network

  # ============================================
  # Mailhog (Email Testing)
  # ============================================
  mailhog:
    image: mailhog/mailhog:latest
    container_name: doa-mailhog
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web UI
    networks:
      - doa-network

  # ============================================
  # Backend Services
  # ============================================
  auth-service:
    build:
      context: ./backend/services/auth-service
      dockerfile: Dockerfile
    container_name: doa-auth-service
    environment:
      NODE_ENV: development
      PORT: 3001
      LOG_LEVEL: debug
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: doa_auth
      DB_USER: postgres
      DB_PASSWORD: postgres123
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: redis123
      JWT_ACCESS_SECRET: dev-access-secret-change-in-production
      JWT_REFRESH_SECRET: dev-refresh-secret-change-in-production
      JWT_ACCESS_EXPIRES_IN: 15m
      JWT_REFRESH_EXPIRES_IN: 7d
      AWS_REGION: ap-northeast-2
      AWS_ENDPOINT: http://localstack:4566
    ports:
      - "3001:3001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - doa-network
    restart: unless-stopped

  user-service:
    build: ./backend/user-service
    container_name: doa-user-service
    environment:
      PORT: 3002
      DB_HOST: postgres
      DB_NAME: doa_users
    ports:
      - "3002:3002"
    depends_on:
      - postgres
      - auth-service
    networks:
      - doa-network

  product-service:
    build:
      context: ./backend/services/product-service
      dockerfile: Dockerfile
    container_name: doa-product-service
    environment:
      NODE_ENV: development
      PORT: 3003
      LOG_LEVEL: debug
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: doa_products
      DB_USER: postgres
      DB_PASSWORD: postgres123
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: redis123
      OPENSEARCH_NODE: http://opensearch:9200
      AWS_REGION: ap-northeast-2
      AWS_ENDPOINT: http://localstack:4566
      S3_BUCKET: doa-market-dev-products
    ports:
      - "3003:3003"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - doa-network
    restart: unless-stopped

  order-service:
    build: ./backend/order-service
    container_name: doa-order-service
    environment:
      PORT: 3004
      DB_HOST: postgres
      DB_NAME: doa_orders
    ports:
      - "3004:3004"
    depends_on:
      - postgres
    networks:
      - doa-network

  payment-service:
    build: ./backend/payment-service
    container_name: doa-payment-service
    environment:
      PORT: 3005
      DB_HOST: postgres
      DB_NAME: doa_payments
    ports:
      - "3005:3005"
    depends_on:
      - postgres
    networks:
      - doa-network

  shipping-service:
    build: ./backend/shipping-service
    container_name: doa-shipping-service
    environment:
      PORT: 3006
      DB_HOST: postgres
      DB_NAME: doa_shippings
    ports:
      - "3006:3006"
    depends_on:
      - postgres
    networks:
      - doa-network

  seller-service:
    build: ./backend/seller-service
    container_name: doa-seller-service
    environment:
      PORT: 3007
      DB_HOST: postgres
      DB_NAME: doa_sellers
    ports:
      - "3007:3007"
    depends_on:
      - postgres
    networks:
      - doa-network

  settlement-service:
    build: ./backend/settlement-service
    container_name: doa-settlement-service
    environment:
      PORT: 3008
      DB_HOST: postgres
      DB_NAME: doa_settlements
    ports:
      - "3008:3008"
    depends_on:
      - postgres
    networks:
      - doa-network

  coupon-service:
    build: ./backend/coupon-service
    container_name: doa-coupon-service
    environment:
      PORT: 3009
      DB_HOST: postgres
      DB_NAME: doa_coupons
    ports:
      - "3009:3009"
    depends_on:
      - postgres
      - redis
    networks:
      - doa-network

  inventory-service:
    build: ./backend/inventory-service
    container_name: doa-inventory-service
    environment:
      PORT: 3010
      DB_HOST: postgres
      DB_NAME: doa_inventory
    ports:
      - "3010:3010"
    depends_on:
      - postgres
      - redis
    networks:
      - doa-network

  notification-service:
    build: ./backend/notification-service
    container_name: doa-notification-service
    environment:
      PORT: 3011
      DB_HOST: postgres
      DB_NAME: doa_notifications
    ports:
      - "3011:3011"
    depends_on:
      - postgres
    networks:
      - doa-network

  review-service:
    build: ./backend/review-service
    container_name: doa-review-service
    environment:
      PORT: 3012
      DB_HOST: postgres
      DB_NAME: doa_reviews
    ports:
      - "3012:3012"
    depends_on:
      - postgres
    networks:
      - doa-network

  search-service:
    build: ./backend/search-service
    container_name: doa-search-service
    environment:
      PORT: 3013
    ports:
      - "3013:3013"
    networks:
      - doa-network

  admin-service:
    build: ./backend/admin-service
    container_name: doa-admin-service
    environment:
      PORT: 3014
    ports:
      - "3014:3014"
    networks:
      - doa-network

  file-service:
    build: ./backend/file-service
    container_name: doa-file-service
    environment:
      PORT: 3015
    ports:
      - "3015:3015"
    networks:
      - doa-network

  stats-service:
    build: ./backend/stats-service
    container_name: doa-stats-service
    environment:
      PORT: 3016
      DB_HOST: postgres
    ports:
      - "3016:3016"
    depends_on:
      - postgres
      - redis
    networks:
      - doa-network

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: doa-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@doamarket.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    depends_on:
      - postgres
    networks:
      - doa-network

# ============================================
# Volumes
# ============================================
volumes:
  postgres_data:
    name: doa_postgres_data
  redis_data:
    name: doa_redis_data
  localstack_data:
    name: doa_localstack_data
  opensearch_data:
    name: doa_opensearch_data

# ============================================
# Networks
# ============================================
networks:
  doa-network:
    driver: bridge
    name: doa-network
