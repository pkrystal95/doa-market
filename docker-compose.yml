# DOA Market Local Development Environment
# Version: 1.0
# Run: docker-compose up -d
# Stop: docker-compose down
# Clean: docker-compose down -v

version: '3.8'

services:
  # ============================================
  # PostgreSQL Database
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: doa-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-databases.sql:/docker-entrypoint-initdb.d/init-databases.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - doa-network

  # ============================================
  # Redis Cache
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: doa-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass redis123
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - doa-network

  # ============================================
  # RabbitMQ (Message Broker)
  # ============================================
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: doa-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: rabbitmq
      RABBITMQ_DEFAULT_PASS: rabbitmq123
      RABBITMQ_DEFAULT_VHOST: doa-market
    ports:
      - "5672:5672"   # AMQP protocol
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - doa-network

  # ============================================
  # LocalStack (AWS Services Emulator)
  # ============================================
  localstack:
    image: localstack/localstack:latest
    container_name: doa-localstack
    environment:
      SERVICES: s3,sqs,sns,dynamodb,secretsmanager,events
      DEBUG: 1
      DATA_DIR: /tmp/localstack/data
      AWS_DEFAULT_REGION: ap-northeast-2
    ports:
      - "4566:4566"
    volumes:
      - localstack_data:/tmp/localstack
      - ./scripts/localstack-init.sh:/etc/localstack/init/ready.d/init.sh
    networks:
      - doa-network

  # ============================================
  # OpenSearch (Search Engine)
  # ============================================
  opensearch:
    image: opensearchproject/opensearch:2.11.0
    container_name: doa-opensearch
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - DISABLE_SECURITY_PLUGIN=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "9200:9200"
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    networks:
      - doa-network

  # ============================================
  # Mailhog (Email Testing)
  # ============================================
  mailhog:
    image: mailhog/mailhog:latest
    container_name: doa-mailhog
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web UI
    networks:
      - doa-network

  # ============================================
  # API Gateway
  # ============================================
  api-gateway:
    build:
      context: ./backend/api-gateway
      dockerfile: Dockerfile
    container_name: doa-api-gateway
    environment:
      NODE_ENV: development
      PORT: 3000
      LOG_LEVEL: debug
      CORS_ORIGINS: http://localhost:3000,http://localhost:5173,http://localhost:5174
      JWT_ACCESS_SECRET: dev-access-secret-change-in-production
      JWT_REFRESH_SECRET: dev-refresh-secret-change-in-production
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4318/v1/traces
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: redis123
    ports:
      - "3000:3000"
    depends_on:
      - jaeger
      - redis
    networks:
      - doa-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/v1/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ============================================
  # Backend Services
  # ============================================
  auth-service:
    build:
      context: ./backend/auth-service
      dockerfile: Dockerfile
    container_name: doa-auth-service
    environment:
      NODE_ENV: development
      PORT: 3001
      LOG_LEVEL: debug
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: doa_auth
      DB_USER: postgres
      DB_PASSWORD: postgres123
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: redis123
      JWT_ACCESS_SECRET: dev-access-secret-change-in-production
      JWT_REFRESH_SECRET: dev-refresh-secret-change-in-production
      JWT_ACCESS_EXPIRES_IN: 15m
      JWT_REFRESH_EXPIRES_IN: 7d
      AWS_REGION: ap-northeast-2
      AWS_ENDPOINT: http://localstack:4566
    ports:
      - "3001:3001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - doa-network
    restart: unless-stopped

  user-service:
    build: ./backend/user-service
    container_name: doa-user-service
    environment:
      PORT: 3002
      DB_HOST: postgres
      DB_NAME: doa_users
    ports:
      - "3002:3002"
    depends_on:
      - postgres
      - auth-service
    networks:
      - doa-network

  product-service:
    build:
      context: ./backend/product-service
      dockerfile: Dockerfile
    container_name: doa-product-service
    environment:
      NODE_ENV: development
      PORT: 3003
      LOG_LEVEL: debug
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: doa_products
      DB_USER: postgres
      DB_PASSWORD: postgres123
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: redis123
      OPENSEARCH_NODE: http://opensearch:9200
      RABBITMQ_URL: amqp://rabbitmq:rabbitmq123@rabbitmq:5672/doa-market
      AWS_REGION: ap-northeast-2
      AWS_ENDPOINT: http://localstack:4566
      S3_BUCKET: doa-market-dev-products
    ports:
      - "3003:3003"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - doa-network
    restart: unless-stopped

  order-service:
    build: ./backend/order-service
    container_name: doa-order-service
    environment:
      PORT: 3004
      DB_HOST: postgres
      DB_NAME: doa_orders
    ports:
      - "3004:3004"
    depends_on:
      - postgres
    networks:
      - doa-network

  payment-service:
    build: ./backend/payment-service
    container_name: doa-payment-service
    environment:
      PORT: 3005
      DB_HOST: postgres
      DB_NAME: doa_payments
    ports:
      - "3005:3005"
    depends_on:
      - postgres
    networks:
      - doa-network

  shipping-service:
    build: ./backend/shipping-service
    container_name: doa-shipping-service
    environment:
      PORT: 3006
      DB_HOST: postgres
      DB_NAME: doa_shippings
    ports:
      - "3006:3006"
    depends_on:
      - postgres
    networks:
      - doa-network

  seller-service:
    build: ./backend/seller-service
    container_name: doa-seller-service
    environment:
      PORT: 3007
      DB_HOST: postgres
      DB_NAME: doa_sellers
    ports:
      - "3007:3007"
    depends_on:
      - postgres
    networks:
      - doa-network

  settlement-service:
    build: ./backend/settlement-service
    container_name: doa-settlement-service
    environment:
      PORT: 3008
      DB_HOST: postgres
      DB_NAME: doa_settlements
    ports:
      - "3008:3008"
    depends_on:
      - postgres
    networks:
      - doa-network

  coupon-service:
    build: ./backend/coupon-service
    container_name: doa-coupon-service
    environment:
      PORT: 3009
      DB_HOST: postgres
      DB_NAME: doa_coupons
    ports:
      - "3009:3009"
    depends_on:
      - postgres
      - redis
    networks:
      - doa-network

  inventory-service:
    build: ./backend/inventory-service
    container_name: doa-inventory-service
    environment:
      PORT: 3010
      DB_HOST: postgres
      DB_NAME: doa_inventory
    ports:
      - "3010:3010"
    depends_on:
      - postgres
      - redis
    networks:
      - doa-network

  notification-service:
    build: ./backend/notification-service
    container_name: doa-notification-service
    environment:
      PORT: 3011
      DB_HOST: postgres
      DB_NAME: doa_notifications
    ports:
      - "3011:3011"
    depends_on:
      - postgres
    networks:
      - doa-network

  review-service:
    build: ./backend/review-service
    container_name: doa-review-service
    environment:
      PORT: 3012
      DB_HOST: postgres
      DB_NAME: doa_reviews
    ports:
      - "3012:3012"
    depends_on:
      - postgres
    networks:
      - doa-network

  search-service:
    build: ./backend/search-service
    container_name: doa-search-service
    environment:
      PORT: 3013
      OPENSEARCH_NODE: http://opensearch:9200
      RABBITMQ_URL: amqp://rabbitmq:rabbitmq123@rabbitmq:5672/doa-market
    ports:
      - "3013:3013"
    depends_on:
      - opensearch
      - rabbitmq
    networks:
      - doa-network

  admin-service:
    build: ./backend/admin-service
    container_name: doa-admin-service
    environment:
      PORT: 3014
    ports:
      - "3014:3014"
    networks:
      - doa-network

  file-service:
    build: ./backend/file-service
    container_name: doa-file-service
    environment:
      PORT: 3015
    ports:
      - "3015:3015"
    networks:
      - doa-network

  stats-service:
    build: ./backend/stats-service
    container_name: doa-stats-service
    environment:
      PORT: 3016
      DB_HOST: postgres
    ports:
      - "3016:3016"
    depends_on:
      - postgres
      - redis
    networks:
      - doa-network

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: doa-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@doamarket.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    depends_on:
      - postgres
    networks:
      - doa-network

  # ============================================
  # Monitoring - Prometheus
  # ============================================
  prometheus:
    image: prom/prometheus:latest
    container_name: doa-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - doa-network
    restart: unless-stopped

  # ============================================
  # Monitoring - Grafana
  # ============================================
  grafana:
    image: grafana/grafana:latest
    container_name: doa-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    ports:
      - "3333:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - prometheus
    networks:
      - doa-network
    restart: unless-stopped

  # ============================================
  # Distributed Tracing - Jaeger
  # ============================================
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: doa-jaeger
    environment:
      - COLLECTOR_ZIPKIN_HOST_PORT=:9411
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "5775:5775/udp"  # accept zipkin.thrift over compact thrift protocol
      - "6831:6831/udp"  # accept jaeger.thrift over compact thrift protocol
      - "6832:6832/udp"  # accept jaeger.thrift over binary thrift protocol
      - "5778:5778"      # serve configs
      - "16686:16686"    # serve frontend
      - "14250:14250"    # accept model.proto
      - "14268:14268"    # accept jaeger.thrift directly from clients
      - "14269:14269"    # admin port: health check at / and metrics at /metrics
      - "4317:4317"      # OTLP gRPC receiver
      - "4318:4318"      # OTLP HTTP receiver
      - "9411:9411"      # Zipkin compatible endpoint
    networks:
      - doa-network
    restart: unless-stopped

  # ============================================
  # Logging - Loki
  # ============================================
  loki:
    image: grafana/loki:latest
    container_name: doa-loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - loki_data:/loki
    networks:
      - doa-network
    restart: unless-stopped

  # ============================================
  # Logging - Promtail
  # ============================================
  promtail:
    image: grafana/promtail:latest
    container_name: doa-promtail
    volumes:
      - /var/log:/var/log
      - ./monitoring/promtail-config.yml:/etc/promtail/config.yml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki
    networks:
      - doa-network
    restart: unless-stopped

# ============================================
# Volumes
# ============================================
volumes:
  postgres_data:
    name: doa_postgres_data
  redis_data:
    name: doa_redis_data
  rabbitmq_data:
    name: doa_rabbitmq_data
  localstack_data:
    name: doa_localstack_data
  opensearch_data:
    name: doa_opensearch_data
  prometheus_data:
    name: doa_prometheus_data
  grafana_data:
    name: doa_grafana_data
  loki_data:
    name: doa_loki_data

# ============================================
# Networks
# ============================================
networks:
  doa-network:
    driver: bridge
    name: doa-network
